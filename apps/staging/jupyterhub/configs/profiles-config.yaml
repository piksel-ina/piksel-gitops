apiVersion: v1
kind: ConfigMap
metadata:
  name: hub-profile-config
  namespace: jupyterhub
data:
  profiles.py: |
    from tornado import web
    import os

    async def get_user_groups(self, user):
        """Extract user groups from AWS Cognito authentication state"""
        try:
            # Retrieve user authentication info
            auth_state = await user.get_auth_state()
            self.log.info(f"Auth state for {user.name}: {auth_state}")

            # Extract Cognito groups from the token
            if auth_state and 'oauth_user' in auth_state:
                cognito_info = auth_state['oauth_user']
                groups = cognito_info.get('cognito:groups', [])
            elif auth_state and 'cognito:groups' in auth_state:
                groups = auth_state['cognito:groups']
            else:
                self.log.warning(f"Could not find cognito:groups for user {user.name}")
                groups = []

            self.log.info(f"User {user.name} belongs to groups: {groups}")
            return groups

        except Exception as e:
            self.log.error(f"Error retrieving groups for {user.name}: {e}")
            return []

    async def custom_options_form(self):
        """Generate dynamic profile options based on user groups"""
        self.log.info(f"Generating profiles for user: {self.user.name}")

        # Define profile configurations
        profiles_config = {
            "base": [
                {
                    "display_name": "Standard Instance",
                    "description": "2 vCPUs, 14GB RAM - Geospatial Learning",
                    "slug": "standard",
                    "default": True,
                    "kubespawner_override": {
                        "cpu_guarantee": 1.5,
                        "cpu_limit": 2.0,
                        "mem_guarantee": "14G",
                        "mem_limit": "14G",
                        "image": "686410905891.dkr.ecr.ap-southeast-3.amazonaws.com/piksel-core:jupyter-v20250808-132239",
                        "storage_capacity": "15Gi",
                        "node_selector": {
                            "jupyter-profile": "standard"
                        },
                        "tolerations": [
                            {
                                "key": "jupyter-profile",
                                "operator": "Equal",
                                "value": "standard",
                                "effect": "NoSchedule"
                            }
                        ],
                        "extra_annotations": {
                            "jupyter-profile": "standard",
                            "karpenter.sh/do-not-disrupt": "true"
                        }
                    }
                }
            ],
            "moderate": [
                {
                    "display_name": "For Developer - Medium Instance",
                    "description": "4 CPUs, 30GB RAM | More permissions but fewer built-in libraries. Build your own environment as needed.",
                    "slug": "medium",
                    "kubespawner_override": {
                        "cpu_guarantee": 3,
                        "cpu_limit": 4.0,
                        "mem_guarantee": "27G",
                        "mem_limit": "30G",
                        "image": "686410905891.dkr.ecr.ap-southeast-3.amazonaws.com/piksel-core:dev-jupyter-b60f81d",
                        "storage_capacity": "60Gi",
                        "node_selector": {
                            "jupyter-profile": "medium"
                        },
                        "tolerations": [
                            {
                                "key": "jupyter-profile",
                                "operator": "Equal",
                                "value": "medium",
                                "effect": "NoSchedule"
                            }
                        ],
                        "extra_annotations": {
                            "karpenter.sh/do-not-disrupt": "true",
                            "jupyter-profile": "medium"
                        },
                        "environment": {
                            "JUPYTER_ENABLE_LAB": "yes",
                            "JUPYTER_ALLOW_INSECURE_WRITES": "1",
                            "GRANT_SUDO": "yes",
                            "SUDO_USER": "jovyan",
                            "CHOWN_HOME": "yes"
                        },
                        "allow_privilege_escalation": True,
                        "init_containers": [
                            {
                                "name": "setup-permissions",
                                "image": "686410905891.dkr.ecr.ap-southeast-3.amazonaws.com/piksel-core:dev-jupyter-b60f81d",
                                "command": ["/bin/bash", "-c"],
                                "args": [
                                    """
                                    set -e
                                    mkdir -p /home/jovyan/.config /home/jovyan/.jupyter
                                    cp -f /etc/skel/.bashrc /home/jovyan/.bashrc || true
                                    cp -f /etc/skel/.config/starship.toml /home/jovyan/.config/starship.toml || true
                                    chown -R 1000:100 /home/jovyan
                                    echo "Permissions setup complete"
                                    """
                                ],
                                "securityContext": {
                                    "runAsUser": 0,
                                    "runAsGroup": 0,
                                    "allowPrivilegeEscalation": True
                                },
                                "volumeMounts": [
                                    {
                                        "name": "volume-{username}", 
                                        "mountPath": "/home/jovyan"
                                    }
                                ]
                            }
                        ]
                    }
                }
            ],
            "power": [
                {
                    "display_name": "For Developer - Large Instance",
                    "description": "8 CPUs, 62GB RAM | More permissions but fewer built-in libraries. Build your own environment as needed.",
                    "slug": "large",
                    "kubespawner_override": {
                        "cpu_guarantee": 7,
                        "cpu_limit": 8.0,
                        "mem_guarantee": "58G",
                        "mem_limit": "62G",
                        "image": "686410905891.dkr.ecr.ap-southeast-3.amazonaws.com/piksel-core:dev-jupyter-b60f81d",
                        "storage_capacity": "60Gi",
                        "pvc_name_template": "claim-{username}-dev",
                        "node_selector": {
                            "jupyter-profile": "large"
                        },
                        "tolerations": [
                            {
                                "key": "jupyter-profile",
                                "operator": "Equal",
                                "value": "large",
                                "effect": "NoSchedule"
                            }
                        ],
                        "extra_annotations": {
                            "karpenter.sh/do-not-disrupt": "true",
                            "jupyter-profile": "large"
                        },
                        "environment": {
                            "JUPYTER_ENABLE_LAB": "yes",
                            "JUPYTER_ALLOW_INSECURE_WRITES": "1",
                            "GRANT_SUDO": "yes",
                            "SUDO_USER": "jovyan",
                            "CHOWN_HOME": "yes"
                        },
                        "allow_privilege_escalation": True,
                        "init_containers": [
                            {
                                "name": "setup-permissions",
                                "image": "686410905891.dkr.ecr.ap-southeast-3.amazonaws.com/piksel-core:dev-jupyter-b60f81d",
                                "command": ["/bin/bash", "-c"],
                                "args": [
                                    """
                                    set -e
                                    mkdir -p /home/jovyan/.config /home/jovyan/.jupyter
                                    cp -f /etc/skel/.bashrc /home/jovyan/.bashrc || true
                                    cp -f /etc/skel/.config/starship.toml /home/jovyan/.config/starship.toml || true
                                    chown -R 1000:100 /home/jovyan
                                    echo "Permissions setup complete"
                                    """
                                ],
                                "securityContext": {
                                    "runAsUser": 0,
                                    "runAsGroup": 0,
                                    "allowPrivilegeEscalation": True
                                },
                                "volumeMounts": [
                                    {
                                        "name": "volume-{username}",
                                        "mountPath": "/home/jovyan"
                                    }
                                ]
                            }
                        ]
                    }
                }
            ],
            "gpu": [
                {
                    "display_name": "GPU Instance",
                    "description": "4 CPUs, 16GB RAM, 20GB storage, 1 NVIDIA GPU | Can't be used temporaryly",
                    "slug": "gpu",
                    "kubespawner_override": {
                        "cpu_guarantee": 4,
                        "cpu_limit": 4,
                        "mem_guarantee": "16G",
                        "mem_limit": "16G",
                        "storage_capacity": "20Gi",
                        "extra_resource_limits": {
                            "nvidia.com/gpu": "1"
                        },
                        "extra_resource_guarantees": {
                            "nvidia.com/gpu": "1"
                        },
                        "tolerations": [
                            {
                                "key": "nvidia.com/gpu",
                                "operator": "Exists",
                                "effect": "NoSchedule"
                            }
                        ]
                    }
                }
            ]
        }

        # Define group hierarchy and access levels
        group_access = {
            "admin": ["base", "moderate", "power", "gpu"],
            "gpu-users": ["base", "moderate", "power", "gpu"],
            "power-users": ["base", "moderate", "power"],
            "moderate-users": ["base", "moderate"],
            "regular-users": ["base"]
        }       

        try:
            # Get user groups from Cognito
            user_groups = await get_user_groups(self, self.user)

            # Default user type and accessible profiles
            user_type = "regular-user"
            accessible_profiles = set(["base"])

            # Check groups in hierarchy order
            if 'admin' in user_groups:
                user_type = "admin"
                accessible_profiles.update(group_access["admin"])
            elif 'gpu-users' in user_groups:
                user_type = "gpu-user"
                accessible_profiles.update(group_access["gpu-users"])
            elif 'power-users' in user_groups:
                user_type = "power-user"
                accessible_profiles.update(group_access["power-users"])
            elif 'moderate-users' in user_groups:
                user_type = "moderate-user"
                accessible_profiles.update(group_access["moderate-users"])
            
            # Build final profile list
            self.profile_list = []
            for profile_type in ["base", "moderate", "power", "gpu"]:
                if profile_type in accessible_profiles:
                    self.profile_list.extend(profiles_config[profile_type])

            self.log.info(f"User {self.user.name} ({user_type}) has access to: {list(accessible_profiles)}")

            self.extra_labels = {
                "user-type": user_type,
                "cognito-groups": "-".join(user_groups),
                "accessible-profiles": "-".join(sorted(accessible_profiles))
            }

            return self._options_form_default()

        except Exception as e:
            self.log.error(f"Error in custom_options_form for {self.user.name}: {e}")
            # Fallback to base profiles if there's an error
            self.profile_list = profiles_config["base"]
            return self._options_form_default()

    c.Spawner.debug = True
    c.JupyterHub.log_level = "DEBUG"
    c.LocalProcessSpawner.debug = True

    # Set cookies to less than 5 day (5 day is the Cognito default cookie expiry)
    c.JupyterHub.cookie_max_age_days = 4.5
    c.JupyterHub.tornado_settings["cookie_options"] = dict(expires_days=4.50)

    # Override options_form
    c.KubeSpawner.options_form = custom_options_form
