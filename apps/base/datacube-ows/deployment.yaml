apiVersion: apps/v1
kind: Deployment
metadata:
  name: datacube-ows
  namespace: open-datacube
  labels:
    app: datacube-ows
    component: web-service
spec:
  replicas: 6
  selector:
    matchLabels:
      app: datacube-ows
  template:
    metadata:
      labels:
        app: datacube-ows
        component: web-service
    spec:
      serviceAccountName: odc-data-reader

      initContainers:
        - name: git-clone-config
          image: alpine/git:v2.52.0
          command:
            - sh
            - -c
            - |
              echo "Cloning OWS configuration from piksel-core repository..."

              git clone --depth 1 --branch ${GIT_BRANCH} \
                https://github.com/piksel-ina/piksel-core.git /tmp/repo

              cp -r /tmp/repo/docker/ows/ows_config /config/
              chmod -R 755 /config/ows_config

              echo "Configuration cloned successfully from branch: ${GIT_BRANCH}"
              echo "Git commit: $(cd /tmp/repo && git rev-parse HEAD)"
              echo "Contents:"
              ls -la /config/ows_config

              if [ -f /config/ows_config/ows_cfg.py ]; then
                echo "âœ“ ows_cfg.py found"
              else
                echo "ERROR: ows_cfg.py not found!"
                exit 1
              fi
          volumeMounts:
            - name: ows-config
              mountPath: /config
          env:
            - name: GIT_BRANCH
              value: "main"

      containers:
        - name: datacube-ows
          image: 686410905891.dkr.ecr.ap-southeast-3.amazonaws.com/ows:12345
          imagePullPolicy: IfNotPresent

          command:
            - "gunicorn"
            - "-b"
            - "0.0.0.0:8000"
            - "-w"
            - "4"
            - "-k"
            - "gevent"
            - "--worker-connections"
            - "1000"
            - "--keep-alive"
            - "75"
            - "--max-requests"
            - "10000"
            - "--max-requests-jitter"
            - "1000"
            - "--timeout"
            - "500"
            - "--log-level"
            - "warning"
            - "--worker-tmp-dir"
            - "/dev/shm"
            - "datacube_ows.wsgi"

          ports:
            - name: http
              containerPort: 8000
              protocol: TCP

          env:
            # Database configuration
            - name: ODC_DEFAULT_DB_HOSTNAME
              value: "pg-proxy-service.database.svc.cluster.local"
            - name: ODC_DEFAULT_DB_PORT
              value: "6432"
            - name: ODC_DEFAULT_DB_USERNAME
              valueFrom:
                secretKeyRef:
                  name: odcread-secret
                  key: username
            - name: ODC_DEFAULT_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: odcread-secret
                  key: password
            - name: ODC_DEFAULT_DB_DATABASE
              value: odc
            - name: ODC_DEFAULT_INDEX_DRIVER
              value: "postgis"
            - name: DB_CONNECTION_TIMEOUT
              value: "120"

            # AWS configuration
            - name: AWS_NO_SIGN_REQUEST
              value: "no"
            - name: AWS_REQUEST_PAYER
              value: "requester"
            - name: AWS_DEFAULT_REGION
              value: "ap-southeast-3"

            # OWS Config
            - name: PYTHONPATH
              value: "/config"
            - name: DATACUBE_OWS_CFG
              value: "ows_config.ows_cfg.ows_cfg"

            # GDAL optimization
            - name: VSI_CACHE
              value: "TRUE"
            - name: VSI_CACHE_SIZE
              value: "536870912"
            - name: GDAL_HTTP_MERGE_CONSECUTIVE_RANGES
              value: "YES"
            - name: GDAL_DISABLE_READDIR_ON_OPEN
              value: "EMPTY_DIR"
            - name: CPL_VSIL_CURL_ALLOWED_EXTENSIONS
              value: ".tif,.tiff,.ovr"

          volumeMounts:
            - name: ows-config
              mountPath: /config
              readOnly: true
            - name: dshm
              mountPath: /dev/shm

          lifecycle:
            preStop:
              exec:
                command:
                  - /bin/sh
                  - -c
                  - sleep 15

          resources:
            requests:
              cpu: "1500m"
              memory: "3Gi"
            limits:
              cpu: "2500m"
              memory: "4Gi"

        - name: healthz
          image: nginx:1.25-alpine
          ports:
            - containerPort: 8080
              name: healthz
          command:
            - sh
            - -c
            - |
              cat >/etc/nginx/conf.d/default.conf <<'EOF'
              server {
                listen 8080;
                access_log off;
                error_log /var/log/nginx/error.log warn;
                location = /healthz {
                  return 200 "ok\n";
                }
              }
              EOF
              nginx -g 'daemon off;'

          readinessProbe:
            httpGet:
              path: /healthz
              port: healthz
            periodSeconds: 10
            timeoutSeconds: 2
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /healthz
              port: healthz
            periodSeconds: 30
            timeoutSeconds: 2
            failureThreshold: 3
          resources:
            requests:
              cpu: 100m
              memory: 200Mi
            limits:
              cpu: 200m
              memory: 400Mi

      volumes:
        - name: ows-config
          emptyDir: {}
        - name: dshm
          emptyDir:
            medium: Memory
            sizeLimit: 2Gi

      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - datacube-ows
                topologyKey: kubernetes.io/hostname

      terminationGracePeriodSeconds: 60
