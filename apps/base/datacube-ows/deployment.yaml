apiVersion: apps/v1
kind: Deployment
metadata:
  name: datacube-ows
  namespace: open-datacube
  labels:
    app: datacube-ows
    component: web-service
spec:
  replicas: 2
  selector:
    matchLabels:
      app: datacube-ows
  template:
    metadata:
      labels:
        app: datacube-ows
        component: web-service
    spec:
      serviceAccountName: data-reader

      containers:
        - name: datacube-ows
          image: 686410905891.dkr.ecr.ap-southeast-3.amazonaws.com/piksel-core:ows-latest
          imagePullPolicy: IfNotPresent

          command:
            - "gunicorn"
            - "-b"
            - "0.0.0.0:8000"
            - "-w"
            - "4"
            - "--keep-alive"
            - "50"
            - "--timeout"
            - "120"
            - "--log-level"
            - "info"
            - "datacube_ows.wsgi"

          ports:
            - name: http
              containerPort: 8000
              protocol: TCP

          env:
            # Database configuration
            - name: ODC_DEFAULT_DB_HOSTNAME
              value: "pg-proxy-service.database.svc.cluster.local"
            - name: ODC_DEFAULT_DB_PORT
              value: "6432"
            - name: ODC_DEFAULT_DB_USERNAME
              valueFrom:
                secretKeyRef:
                  name: odcread-secret
                  key: username
            - name: ODC_DEFAULT_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: odcread-secret
                  key: password
            - name: ODC_DEFAULT_DB_DATABASE
              value: odc
            - name: ODC_DEFAULT_INDEX_DRIVER
              value: "postgis"

            # OWS configuration
            - name: PYTHONPATH
              value: "/env/config"
            - name: DATACUBE_OWS_CFG
              value: ows_config.ows.ows_cfg
            - name: WMS_CONFIG_PATH
              value: /env/config/ows_config/ows.py
            - name: PROXY_FIX
              value: "yes"

            # AWS configuration
            - name: AWS_NO_SIGN_REQUEST
              value: "no"
            - name: AWS_REQUEST_PAYER
              value: "requester"
            - name: AWS_DEFAULT_REGION
              value: "ap-southeast-3"

            # GDAL optimization
            - name: VSI_CACHE
              value: "TRUE"
            - name: VSI_CACHE_SIZE
              value: "536870912" # 512MB
            - name: GDAL_HTTP_MERGE_CONSECUTIVE_RANGES
              value: "YES"
            - name: GDAL_DISABLE_READDIR_ON_OPEN
              value: "EMPTY_DIR"
            - name: CPL_VSIL_CURL_ALLOWED_EXTENSIONS
              value: ".tif,.tiff,.ovr"

          resources:
            requests:
              cpu: "1000m"
              memory: "1Gi"
            limits:
              cpu: "2000m"
              memory: "2Gi"

          volumeMounts:
            - name: ows-config
              mountPath: /env/config/ows_config
              readOnly: true

          livenessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          startupProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 30

      volumes:
        - name: ows-config
          configMap:
            name: ows-config

      # Pod anti-affinity for better distribution
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - datacube-ows
                topologyKey: kubernetes.io/hostname

      terminationGracePeriodSeconds: 60
