apiVersion: argoproj.io/v1alpha1
kind: CronWorkflow
metadata:
  name: daily-landsat-st
  namespace: argo-workflows
spec:
  schedule: "0 0 * * *"
  concurrencyPolicy: "Replace"
  startingDeadlineSeconds: 0
  workflowSpec:
    serviceAccountName: argo-workflows-executor
    entrypoint: daily-landsat-st-workflow
    podGC:
      strategy: OnWorkflowCompletion
    ttlStrategy:
      secondsAfterCompletion: 10
      secondsAfterSuccess: 5
      secondsAfterFailure: 600
    parallelism: 1
    templates:
      - name: daily-landsat-st-workflow
        steps:
          - - name: generate-daterange
              template: gen-date

          - - name: index-landsat-9-st
              templateRef:
                name: datacube-stac-indexer
                template: stac-indexing
              arguments:
                parameters:
                  - name: catalog
                    value: "https://landsatlook.usgs.gov/stac-server/"
                  - name: collections
                    value: "landsat-c2l2-st"
                  - name: bbox
                    value: "{{ item }}"
                  - name: datetime
                    value: "{{ steps.generate-daterange.outputs.result }}"
                  - name: arguments
                    value: '--rename-product=ls9_c2l2_st --options="query={\"platform\":{\"in\":[\"LANDSAT_9\"]}}" --url-string-replace="https://landsatlook.usgs.gov/data,s3://usgs-landsat"'
              withItems:
                - "95.0,-11.0,110.0,6.0" # Western Indonesia
                - "110.0,-11.0,125.0,6.0" # Central Indonesia
                - "125.0,-11.0,141.0,6.0" # Eastern Indonesia

          - - name: index-landsat-8-st
              templateRef:
                name: datacube-stac-indexer
                template: stac-indexing
              arguments:
                parameters:
                  - name: catalog
                    value: "https://landsatlook.usgs.gov/stac-server/"
                  - name: collections
                    value: "landsat-c2l2-st"
                  - name: bbox
                    value: "{{ item }}"
                  - name: datetime
                    value: "{{ steps.generate-daterange.outputs.result }}"
                  - name: arguments
                    value: '--rename-product=ls8_c2l2_st  --options="query={\"platform\":{\"in\":[\"LANDSAT_8\"]}}" --url-string-replace="https://landsatlook.usgs.gov/data,s3://usgs-landsat"'
              withItems:
                - "95.0,-11.0,110.0,6.0" # Western Indonesia
                - "110.0,-11.0,125.0,6.0" # Central Indonesia
                - "125.0,-11.0,141.0,6.0" # Eastern Indonesia

      - name: gen-date
        script:
          image: python:3.8
          command: [python]
          source: |
            import datetime
            import json
            import os
            import sys
            from typing import Any, Dict

            def main() -> None:
                today = datetime.datetime.utcnow().date()
                five_days_ago = today - datetime.timedelta(days=5)
                daterange = f"{five_days_ago.strftime('%Y-%m-%d')}/{today.strftime('%Y-%m-%d')}"
                print(daterange)

            if __name__ == "__main__":
                main()
