apiVersion: v1
kind: ConfigMap
metadata:
  name: db-user-creation-script
  namespace: database
data:
  create_users.sh: |
    #!/bin/bash
    set -e

    # Function to create or update user
    create_or_update_user() {
        local username=$1
        local password=$2
        local permissions=$3
        
        echo "Processing user: $username"
        
        # Use psql with environment variables - no sed needed!
        psql -h "$DB_HOST" -U "$DB_ADMIN_USER" -d "$DATABASE_NAME" << EOF
    DO \$\$
    DECLARE
        user_exists boolean;
    BEGIN
        SELECT EXISTS(SELECT FROM pg_roles WHERE rolname = '$username') INTO user_exists;
        IF NOT user_exists THEN
            EXECUTE 'CREATE ROLE $username WITH LOGIN PASSWORD ' || quote_literal('$password');
            RAISE NOTICE 'Created user: $username';
        ELSE
            EXECUTE 'ALTER ROLE $username WITH PASSWORD ' || quote_literal('$password');
            RAISE NOTICE 'Updated password for user: $username';
        END IF;
    END \$\$;

    GRANT CONNECT ON DATABASE $DATABASE_NAME TO $username;
    GRANT USAGE ON SCHEMA public TO $username;
    $permissions
    EOF
        
        echo "User $username processed"
    }

    echo "Starting database user creation process..."

    # Create users with their specific permissions
    create_or_update_user "argo" "$ARGO_PASSWORD" "GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO argo;"

    create_or_update_user "jupyterhub" "$JUPYTERHUB_PASSWORD" "GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO jupyterhub;"

    create_or_update_user "grafana" "$GRAFANA_PASSWORD" "GRANT SELECT ON ALL TABLES IN SCHEMA public TO grafana;"

    create_or_update_user "stacread" "$STACREAD_PASSWORD" "GRANT SELECT ON ALL TABLES IN SCHEMA public TO stacread;"

    create_or_update_user "stac" "$STAC_PASSWORD" "GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO stac;"

    create_or_update_user "odcread" "$ODCREAD_PASSWORD" "GRANT SELECT ON ALL TABLES IN SCHEMA public TO odcread;"

    create_or_update_user "odc" "$ODC_PASSWORD" "GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO odc;"

---
apiVersion: batch/v1
kind: Job
metadata:
  name: db-user-creation-v4
  namespace: database
spec:
  template:
    spec:
      containers:
        - name: postgres-client
          image: alpine:3.22
          command:
            - /bin/sh
            - -c
            - |
              # Install packages
              apk add --no-cache bash curl postgresql-client

              # Check if PGPASSWORD needs base64 decoding (try decode, fallback to original)
              if echo "$PGPASSWORD" | base64 -d >/dev/null 2>&1; then
                  DECODED_PGPASSWORD=$(echo "$PGPASSWORD" | base64 -d)
                  echo "Admin password was base64 encoded, decoded successfully"
              else
                  DECODED_PGPASSWORD="$PGPASSWORD"
                  echo "Admin password is already plain text"
              fi
              export PGPASSWORD="$DECODED_PGPASSWORD"

              # User passwords - assume they are plain text (no base64 decoding)
              echo "Using user passwords as plain text (no base64 decoding)"

              # Download SSL cert
              curl -o /tmp/rds-ca.pem https://truststore.pki.rds.amazonaws.com/ap-southeast-3/ap-southeast-3-bundle.pem
              export PGSSLMODE=verify-ca
              export PGSSLROOTCERT=/tmp/rds-ca.pem

              # Copy script to writable location and run it
              cp /scripts/create_users.sh /tmp/create_users.sh
              chmod +x /tmp/create_users.sh
              /tmp/create_users.sh
          env:
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: db-password
                  key: password
            - name: DB_HOST
              valueFrom:
                secretKeyRef:
                  name: db-password
                  key: db_address
            - name: DB_ADMIN_USER
              valueFrom:
                secretKeyRef:
                  name: db-password
                  key: username
            - name: DATABASE_NAME
              valueFrom:
                secretKeyRef:
                  name: db-password
                  key: db_name
            - name: ARGO_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: argo
                  key: password
            - name: JUPYTERHUB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: jupyterhub
                  key: password
            - name: GRAFANA_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: grafana
                  key: password
            - name: STACREAD_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: stacread
                  key: password
            - name: STAC_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: stac
                  key: password
            - name: ODCREAD_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: odcread
                  key: password
            - name: ODC_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: odc
                  key: password
          volumeMounts:
            - name: script
              mountPath: /scripts
      volumes:
        - name: script
          configMap:
            name: db-user-creation-script
            defaultMode: 0755
      restartPolicy: OnFailure
